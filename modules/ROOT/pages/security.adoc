= Security
:page-aliases: ios_security.adoc
:toc: right
// :toclevels: 1

:keywords: ownCloud, security, encryption, mdm, ssl, tls, oauth2, authentication, ios, iphone, ipad
:description: This guide steps you through the security features of of ownCloud's Mobile App for iOS.
:apple-completeuntilfirstuserauthentication-url: https://developer.apple.com/documentation/foundation/nsfileprotectioncompleteuntilfirstuserauthentication
:apple-security-accessibleafterfirstunlock-url: https://developer.apple.com/documentation/security/ksecattraccessibleafterfirstunlock
:sfauthenticationsession-url: https://developer.apple.com/documentation/safariservices/sfauthenticationsession
:aswebauthenticationsession-url: https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession
:rfc-8252-url: https://tools.ietf.org/html/rfc8252#appendix-B.1
:apple-wkwebview-url: https://developer.apple.com/documentation/webkit/wkwebview
:basic-authentication-url: https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication#Basic_authentication_scheme
:css-keylogging-url: https://github.com/maxchehab/CSS-Keylogging
:ios-sdk-basicauth-url: https://github.com/owncloud/ios-sdk/blob/master/ownCloudSDK/Authentication/OCAuthenticationMethodBasicAuth.m
:ios-sdk-general-purpose-api-url: https://github.com/owncloud/ios-sdk/blob/master/ownCloudSDK/Authentication/OCAuthenticationMethod.h
:ios-sdk-oauth2-url: https://github.com/owncloud/ios-sdk/blob/master/ownCloudSDK/Authentication/OCAuthenticationMethodOAuth2.m
:ios-sdk-openssl-build-script-url: https://github.com/owncloud/ios-sdk/tree/master/ownCloudUI/openssl/build-script
:ios-sdk-openssl-lib-url: https://github.com/owncloud/ios-sdk/tree/master/ownCloudUI/openssl/lib
:ios-sdk-sync-strategies-url: https://github.com/owncloud/ios-sdk/blob/master/doc/SYNC.md
:oauth2-url: https://oauth.net/2/
:owncloud-ios-app: https://github.com/owncloud/ios-app
:owncloud-ios-sdk: https://github.com/owncloud/ios-sdk
:ios-filesystem-encryption-url: https://developer.apple.com/library/archive/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/StrategiesforImplementingYourApp/StrategiesforImplementingYourApp.html#//apple_ref/doc/uid/TP40007072-CH5-SW21
:security-information-url: https://github.com/owncloud/ios-app/blob/master/doc/SECURITY.md

== Introduction

This document provides an overview of the security considerations and features in the new {owncloud-ios-sdk}[ownCloud iOS SDK] and new {owncloud-ios-app}[ownCloud iOS App].

== Authentication

=== API

The ownCloud iOS SDK (2018) is a {ios-sdk-general-purpose-api-url}[general-purpose API] for implementing passphrase- and token-based authentication methods, which provides three key benefits. These are:

. Ensures structural separation of code between general connection-handling and authentication.
. Simplifies code reviews, by limiting each implementation to one class each (e.g.,
  {ios-sdk-oauth2-url}[OAuth2], {ios-sdk-basicauth-url}[BasicAuth]).
. Ensures extensibility.

=== Secrets

Authentication secrets contain information such as _usernames_, _passwords_ or _tokens_, and are
generated by the respective authentication method implementation. Authentication Secrets are securely
stored in the app's Keychain and tagged as
{apple-security-accessibleafterfirstunlock-url}[`AccessibleAfterFirstUnlock`]. 
They cannot be accessed after a restart until the device has been unlocked once by the user.

=== Supported Methods

Authentication method implementations are available for
{oauth2-url}[OAuth2] and {basic-authentication-url}[Basic Authentication].

=== Method Selection

After performing auto-detection, identified authentication methods are filtered and ranked by preference. The method with the highest ranking is then picked for the user.

NOTE: By default, all detected methods are considered and OAuth2 ranks higher than Basic Authentication.

Filtering and ranking can be customized by xref:appendices/mdm.adoc[MDM Configuration]. This, for example, allows making OAuth2 the only possible authentication method, so no credentials need to be stored on the device.

=== OAuth2 Implementation

The OAuth2 implementation uses {sfauthenticationsession-url}[`SFAuthenticationSession`], which is described as a best practice by {rfc-8252-url}[`RFC 8252`] - when running under iOS 11. Under iOS 12, the OAuth2 implementation uses {aswebauthenticationsession-url}[`ASWebAuthenticationSession`], which is the successor of `SFAuthenticationSession`. Benefits of using these APIs include:

* *Privilege separation:* web content is run in a separate process
* *Trustworthiness:* apps can't inject code into or access the contents of the web view
* *Convenience for the user:* cookies from Safari are available to the web content inside the session

== Connections

=== URL Limits

Using xref:appendices/mdm.adoc[MDM Configuration], server URLs can be pre-filled or "hard-coded" as the only allowed server URL.

=== Redirects

Redirects during login are not followed silently. Instead, they are reported to the user and must be explicitly approved.

=== SSL/TLS Certificates

When adding servers, users have the opportunity to view a detailed summary of the server's SSL/TLS certificate before they are prompted for credentials or authentication via OAuth2.

If a SSL/TLS certificate fails trust evaluation (e.g., because it's self-signed or signed by an unknown Certificate Authority), the user is given an opportunity to: 

* View a detailed summary of the certificate, by clicking on the notification.
* Trust the certificate, despite the warnings, by clicking btn:[Approve].
* Reject the certificate, by clicking btn:[Cancel].

image:security/04_cert_error.png[Review SSL/TLS certificates in the ownCloud iOS app., width=35%,pdfwidth=35%]

In the case of redirects across several HTTPS servers, users are given the opportunity to review the certificates of all servers involved in addition to the redirects.

[NOTE]
====
MDM Configuration support is planned for:

* Pre-approving specific certificates and certificates with specific public keys.
* Allowing only connections with specific certificates or certificates with specific public keys.
====

=== Inspecting Certificate Details

If users want to inspect the details of an approved security certificate, from the Accounts list, swipe left on the account that you want to check the certificate of and click btn:[Edit]. Then, click the row btn:[Certificate Details]. You will then see the certificate’s details, starting with the validation status. 

=== More Information

For more information, please refer to {security-information-url}[the security information].

== Data

=== Separation

Separate directories are used for the data of every server connection. This provides the following benefits:

- A strong barrier against accidentally spilling data between different connections.
- All data relating to a connection can be deleted by deleting the respective directory.

=== Encryption

The app uses the {ios-filesystem-encryption-url}[filesystem encryption built into iOS]. Using the {apple-completeuntilfirstuserauthentication-url}[`CompleteUntilFirstUserAuthentication`] file protection, data can't be accessed after a restart until the device has been unlocked once by the user.

=== Sync

The {ios-sdk-sync-strategies-url}[Sync Strategies], planned to be used in the app, focus on preventing data loss locally and remotely.

=== Secure Document View

HTML and Microsoft Office document content is viewed using {apple-wkwebview-url}[`WKWebView`], which renders the content in a separate process. Additional hardening is achieved by disabling JavaScript and blocking all network requests, which protects against lesser known, non-obvious attacks like {css-keylogging-url}[CSS Keylogging].

=== Passcode

Users can set a Passcode to control access to the app. Find out more about this in the
xref:settings.adoc#passcode[Passcode section of the Settings documentation].

== Miscellaneous

=== Continuous Integration (CI)

Continuous Integration tests verify that central security mechanisms and assumptions work as expected, covering areas such as _redirections_, _certificate handling_, common Man-in-the-middle (MITM) attack scenarios, and the secure storage of authentication secrets.

=== SQL Injection

To protect against SQL injection attacks, parameters are never made part of the SQL statements themselves. Instead, placeholders are used and the parameters are subsequently bound to the SQL statements. For example, instead of running a query, such as `SELECT * FROM users WHERE name='John Doe'`, the query would be parameterised, such as: `SELECT * FROM users WHERE name=:nameToSearchFor`.

=== Reproducibility

The build script that created the {ios-sdk-openssl-lib-url}[OpenSSL binaries] used in the app is available in the SDK's {ios-sdk-openssl-build-script-url}[GitHub repository] and can be used to reproduce the build result.

NOTE: OpenSSL is used solely to provide detailed summaries of SSL/TLS certificates - functionality that iOS is currently missing.

=== Planned Logging Feature (not included in released yet!!)

When logging information, parts of the log message can be tagged as private. If "*Mask private data*" is enabled, under menu:Settings[Logging] (it is by default), these parts will be - before the log message is written - either replaced with `«private»` or a trimmed version that doesn't contain privacy-sensitive information.

An example for the latter would be an `NSError` object's error message containing the names of the item it is about. If masked, only the error's error domain and error code are written to the log, but not the error message.

image:security/masking-private-data.png[, width=40%,pdfwidth=40%]
